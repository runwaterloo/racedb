# The following variables need to be setup in GitLab under Settings | CI / CD | Variables
# GITLAB_CI_USER        (GitLab access token name)
# GITLAB_CI_TOKEN       (GitLab access token)
# AWS_ACCESS_KEY_ID     (AWS access key for S3)
# AWS_SECRET_ACCESS_KEY (AWS secret access key for S3)
# RACEDB_DB_BACKUP      (location of backup s3://...)
# PERSONAL_ACCESS_TOKEN (Gitlab personal access token)
# NOTIFYKEY             (RRW key to accept notifications)

stages:
  - default
  - update-dependencies

default:
  stage: default
  rules:
    - if: '$UPDATE_DEPENDENCIES == "true"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_TAG'    # tag exists (non-empty)
      when: never
    - when: always
  image: docker:latest
  services:
    - docker:dind
    - mariadb:10.11.9
  variables:
    MYSQL_DATABASE: racedb
    MYSQL_USER: racedb
    MYSQL_PASSWORD: CHANGEME
    MYSQL_ROOT_PASSWORD: CHANGEME
  script:
    - sh deploy/gitlab/build.sh
    - sh deploy/gitlab/test.sh
    # exit here if not main, and [push dev] not present
    - if [ "$CI_COMMIT_BRANCH" != "$CI_DEFAULT_BRANCH" ] && ! echo "$CI_COMMIT_MESSAGE" | grep -q '\[push dev\]'; then exit 0; fi
    - sh deploy/gitlab/push.sh
    - apk add curl git tzdata -f
    - export VERSION="1.$(TZ=America/Toronto date +'%y%m%d').$CI_PIPELINE_IID"
    - sh deploy/gitlab/tag.sh
  retry: 1
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    reports:
      junit: report.xml
    expire_in: 1 week

update-dependencies:
  stage: update-dependencies
  image: python:latest
  rules:
    - if: '$UPDATE_DEPENDENCIES == "true"'
  script:
    - ./update-dependencies.sh
