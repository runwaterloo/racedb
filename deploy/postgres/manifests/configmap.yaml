---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  labels:
    app: postgres
data:
  # the racedb database and user are created by default
  # the racedbdev database and user are created using the init script below
  init-db.sql: |
    -- Create user if it doesn't exist
    SELECT CASE
      WHEN NOT EXISTS (SELECT FROM pg_user WHERE usename = :'devuser')
      THEN 'CREATE USER ' || quote_ident(:'devuser') || ' WITH PASSWORD ' || quote_literal(:'devpass')
      ELSE 'SELECT NULL'
    END \gexec

    -- Create database if it doesn't exist
    SELECT CASE
      WHEN NOT EXISTS (SELECT FROM pg_database WHERE datname = :'devdb')
      THEN 'CREATE DATABASE ' || quote_ident(:'devdb') || ' OWNER ' || quote_ident(:'devuser')
      ELSE 'SELECT NULL'
    END \gexec

    -- Grant privileges (will be idempotent)
    SELECT 'GRANT ALL PRIVILEGES ON DATABASE ' || quote_ident(:'devdb') || ' TO ' || quote_ident(:'devuser') \gexec
